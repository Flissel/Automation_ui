<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Desktop Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .streaming { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        #canvas {
            border: 2px solid #ddd;
            margin: 10px 0;
            background: #000;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mock Desktop Client</h1>
        <p>This simulates a desktop client that can stream fake desktop content.</p>
        
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div>
            <button id="connectBtn" class="btn-primary" onclick="connect()">Connect</button>
            <button id="disconnectBtn" class="btn-secondary" onclick="disconnect()" disabled>Disconnect</button>
            <button id="startStreamBtn" class="btn-success" onclick="startStreaming()" disabled>Start Streaming</button>
            <button id="stopStreamBtn" class="btn-danger" onclick="stopStreaming()" disabled>Stop Streaming</button>
        </div>
        
        <div>
            <h3>Simulated Desktop Content</h3>
            <canvas id="canvas" width="800" height="600"></canvas>
        </div>
        
        <div>
            <h3>Logs</h3>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let isStreaming = false;
        let streamInterval = null;
        let clientId = `desktop_client_${Date.now()}`;
        
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logsEl.innerHTML += `[${timestamp}] ${message}<br>`;
            logsEl.scrollTop = logsEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status, className) {
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
        }
        
        function updateButtons() {
            document.getElementById('connectBtn').disabled = isConnected;
            document.getElementById('disconnectBtn').disabled = !isConnected;
            document.getElementById('startStreamBtn').disabled = !isConnected || isStreaming;
            document.getElementById('stopStreamBtn').disabled = !isConnected || !isStreaming;
        }
        
        function connect() {
            try {
                ws = new WebSocket('ws://localhost:8084');
                
                ws.onopen = () => {
                    isConnected = true;
                    updateStatus('Connected', 'connected');
                    updateButtons();
                    log('Connected to WebSocket server');
                    
                    // Send handshake
                    const handshake = {
                        type: 'handshake',
                        clientInfo: {
                            clientType: 'desktop_capture',
                            clientId: clientId,
                            capabilities: ['screen_capture', 'streaming']
                        }
                    };
                    ws.send(JSON.stringify(handshake));
                    log('Sent handshake as desktop client');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        log(`Error parsing message: ${error.message}`);
                    }
                };
                
                ws.onclose = () => {
                    isConnected = false;
                    isStreaming = false;
                    updateStatus('Disconnected', 'disconnected');
                    updateButtons();
                    log('WebSocket connection closed');
                    
                    if (streamInterval) {
                        clearInterval(streamInterval);
                        streamInterval = null;
                    }
                };
                
                ws.onerror = (error) => {
                    log(`WebSocket error: ${error}`);
                };
                
            } catch (error) {
                log(`Connection error: ${error.message}`);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function handleMessage(message) {
            log(`Received: ${message.type}`);
            
            switch (message.type) {
                case 'handshake_ack':
                    log('Handshake acknowledged');
                    break;
                    
                case 'start_desktop_stream':
                case 'start_capture':
                    log('Received start stream request');
                    startStreaming();
                    break;
                    
                case 'stop_desktop_stream':
                case 'stop_capture':
                    log('Received stop stream request');
                    stopStreaming();
                    break;
                    
                case 'ping':
                    // Respond to ping
                    ws.send(JSON.stringify({
                        type: 'pong',
                        timestamp: Date.now()
                    }));
                    break;
                    
                default:
                    log(`Unknown message type: ${message.type}`);
            }
        }
        
        function generateFakeDesktopFrame() {
            // Clear canvas with desktop background
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw fake desktop elements
            const time = Date.now() / 1000;
            
            // Desktop wallpaper pattern
            ctx.fillStyle = '#34495e';
            for (let i = 0; i < 20; i++) {
                for (let j = 0; j < 15; j++) {
                    if ((i + j) % 2 === 0) {
                        ctx.fillRect(i * 40, j * 40, 40, 40);
                    }
                }
            }
            
            // Taskbar
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
            
            // Start button
            ctx.fillStyle = '#0078d4';
            ctx.fillRect(10, canvas.height - 35, 60, 30);
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px Arial';
            ctx.fillText('Start', 25, canvas.height - 18);
            
            // System tray
            ctx.fillStyle = '#333333';
            ctx.fillRect(canvas.width - 120, canvas.height - 35, 110, 30);
            ctx.fillStyle = '#ffffff';
            ctx.font = '10px Arial';
            ctx.fillText(new Date().toLocaleTimeString(), canvas.width - 110, canvas.height - 18);
            
            // Moving window
            ctx.fillStyle = '#ffffff';
            const windowX = 100 + (Math.sin(time * 0.5) * 0.5 + 0.5) * (canvas.width - 300);
            const windowY = 100 + (Math.cos(time * 0.3) * 0.5 + 0.5) * (canvas.height - 250);
            ctx.fillRect(windowX, windowY, 200, 150);
            
            // Window title bar
            ctx.fillStyle = '#0078d4';
            ctx.fillRect(windowX, windowY, 200, 25);
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px Arial';
            ctx.fillText('Mock Application', windowX + 5, windowY + 17);
            
            // Window close button
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(windowX + 175, windowY + 5, 15, 15);
            ctx.fillStyle = '#ffffff';
            ctx.font = '10px Arial';
            ctx.fillText('Ã—', windowX + 180, windowY + 14);
            
            // Pulsing circle (cursor simulation)
            ctx.fillStyle = '#e74c3c';
            const radius = 8 + Math.sin(time * 3) * 3;
            const cursorX = 200 + Math.sin(time * 2) * 100;
            const cursorY = 200 + Math.cos(time * 1.5) * 80;
            ctx.beginPath();
            ctx.arc(cursorX, cursorY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Desktop icons
            const iconPositions = [
                {x: 50, y: 50, name: 'Computer'},
                {x: 50, y: 120, name: 'Documents'},
                {x: 50, y: 190, name: 'Network'},
                {x: 50, y: 260, name: 'Recycle Bin'}
            ];
            
            iconPositions.forEach((icon, index) => {
                // Icon background
                ctx.fillStyle = '#3498db';
                ctx.fillRect(icon.x, icon.y, 32, 32);
                
                // Icon highlight effect
                const highlight = Math.sin(time + index) * 0.3 + 0.7;
                ctx.fillStyle = `rgba(255, 255, 255, ${highlight * 0.3})`;
                ctx.fillRect(icon.x, icon.y, 32, 32);
                
                // Icon label
                ctx.fillStyle = '#ffffff';
                ctx.font = '10px Arial';
                const textWidth = ctx.measureText(icon.name).width;
                ctx.fillText(icon.name, icon.x + 16 - textWidth/2, icon.y + 45);
            });
            
            // Client info overlay
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(10, 10, 300, 60);
            ctx.fillStyle = '#00ff00';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(`Desktop Client: ${clientId.substring(15)}`, 20, 30);
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px Arial';
            ctx.fillText(`Resolution: ${canvas.width}x${canvas.height}`, 20, 45);
            ctx.fillText(`Time: ${new Date().toLocaleTimeString()}`, 20, 60);
            
            // Random activity indicators
            for (let i = 0; i < 8; i++) {
                ctx.fillStyle = `hsl(${(time * 50 + i * 45) % 360}, 70%, 50%)`;
                const size = 20 + Math.sin(time * 2 + i) * 10;
                const sx = 150 + i * 80 + Math.sin(time + i) * 30;
                const sy = 350 + Math.cos(time * 1.5 + i) * 100;
                ctx.fillRect(sx, sy, size, size);
            }
            
            // Convert canvas to base64
            return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        }
        
        function startStreaming() {
            if (!isConnected || isStreaming) return;
            
            isStreaming = true;
            updateStatus('Connected & Streaming', 'streaming');
            updateButtons();
            log('Started streaming fake desktop content');
            
            // Send stream status
            ws.send(JSON.stringify({
                type: 'desktop_stream_status',
                desktopClientId: clientId,
                status: {
                    streaming: true,
                    connectionName: `Mock Desktop ${clientId.substring(15)}`,
                    fpsActual: 10,
                    latency: Math.floor(Math.random() * 50) + 10
                }
            }));
            
            // Start sending frames
            streamInterval = setInterval(() => {
                if (isStreaming && ws && ws.readyState === WebSocket.OPEN) {
                    const frameData = generateFakeDesktopFrame();
                    
                    const frameMessage = {
                        type: 'frame_data',
                        desktopClientId: clientId,
                        frameData: frameData,
                        metadata: {
                            timestamp: new Date().toISOString(),
                            width: canvas.width,
                            height: canvas.height,
                            format: 'jpeg'
                        }
                    };
                    
                    ws.send(JSON.stringify(frameMessage));
                }
            }, 100); // 10 FPS
        }
        
        function stopStreaming() {
            if (!isStreaming) return;
            
            isStreaming = false;
            updateStatus('Connected', 'connected');
            updateButtons();
            log('Stopped streaming');
            
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
            
            // Send stream status
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'desktop_stream_status',
                    desktopClientId: clientId,
                    status: {
                        streaming: false,
                        connectionName: `Mock Desktop ${clientId.substring(15)}`,
                        fpsActual: 0,
                        latency: 0
                    }
                }));
            }
        }
        
        // Initialize
        updateButtons();
        log('Mock Desktop Client initialized');
        log(`Client ID: ${clientId}`);
    </script>
</body>
</html>